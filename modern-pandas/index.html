<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
      <meta name="description" content="A blog about SCM, programming, life, and other things." />
      
    

      <title>Dong - Pandas Tricks</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
              
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
                  onload="renderMathInElement(document.body);"></script>
              
          
      

      
          <link rel="stylesheet" href="https://blog.xiongdong57.top/site.css">
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;" class="logo">Dong</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;">Dong</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://blog.xiongdong57.top/modern-pandas/#method-chain" class="toc-link">Method Chain</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.xiongdong57.top/modern-pandas/#dataframe-assign" class="toc-link">DataFrame.assign</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.xiongdong57.top/modern-pandas/#dataframe-pipe" class="toc-link">DataFrame.pipe</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://blog.xiongdong57.top/modern-pandas/#timeseries" class="toc-link">TimeSeries</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.xiongdong57.top/modern-pandas/#timeseries-slice" class="toc-link">TimeSeries Slice</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.xiongdong57.top/modern-pandas/#timeseries-resample" class="toc-link">TimeSeries Resample</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;modern-pandas&#x2F;">Pandas Tricks</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2021-10-31</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>工作中偶尔会用到Pandas处理数据，Pandas功能丰富，也有很多不同的使用方式。以下纪录一些自己觉得比较有意思的用法。</p>
<span id="continue-reading"></span><h2 id="method-chain">Method Chain</h2>
<p>先看一段样例代码</p>
<pre data-lang="Python" style="background-color:#2b303b;color:#c0c5ce;" class="language-Python "><code class="language-Python" data-lang="Python"><span style="color:#65737e;"># above have createde a dataframe
</span><span>df.</span><span style="color:#bf616a;">drop_duplicates</span><span>(</span><span style="color:#bf616a;">subset</span><span>=[&#39;</span><span style="color:#a3be8c;">col1</span><span>&#39;], </span><span style="color:#bf616a;">keep</span><span>=&#39;</span><span style="color:#a3be8c;">first</span><span>&#39;)
</span><span>
</span><span>df2 = pd.</span><span style="color:#bf616a;">merge</span><span>(df, df_category, </span><span style="color:#bf616a;">on</span><span>=&#39;</span><span style="color:#a3be8c;">code</span><span>&#39;, </span><span style="color:#bf616a;">how</span><span>=&#39;</span><span style="color:#a3be8c;">left</span><span>&#39;)
</span><span>df3 = pd.</span><span style="color:#bf616a;">merge</span><span>(df2, df_saleType, </span><span style="color:#bf616a;">on</span><span>=&#39;</span><span style="color:#a3be8c;">code</span><span>&#39;, </span><span style="color:#bf616a;">how</span><span>=&#39;</span><span style="color:#a3be8c;">left</span><span>&#39;)
</span><span>df4 = pd.</span><span style="color:#bf616a;">merge</span><span>(df3, product_info, </span><span style="color:#bf616a;">on</span><span>=&#39;</span><span style="color:#a3be8c;">code</span><span>&#39;, </span><span style="color:#bf616a;">how</span><span>=&#39;</span><span style="color:#a3be8c;">left</span><span>&#39;)
</span><span>
</span><span>df4.</span><span style="color:#bf616a;">rename</span><span>(</span><span style="color:#bf616a;">columns</span><span>={&#39;</span><span style="color:#a3be8c;">old_name</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">new_name</span><span>&#39;})
</span><span>
</span><span>df4[&#39;</span><span style="color:#a3be8c;">category</span><span>&#39;] = df4[&#39;</span><span style="color:#a3be8c;">category</span><span>&#39;].</span><span style="color:#bf616a;">apply</span><span>(clean_category)
</span><span>df4[&#39;</span><span style="color:#a3be8c;">saleType</span><span>&#39;] = df4[&#39;</span><span style="color:#a3be8c;">saleType</span><span>&#39;].</span><span style="color:#bf616a;">apply</span><span>(clean_saleType)
</span><span>df4[&#39;</span><span style="color:#a3be8c;">price</span><span>&#39;] = df4[&#39;</span><span style="color:#a3be8c;">price</span><span>&#39;].</span><span style="color:#bf616a;">apply</span><span>(clean_price)
</span><span style="color:#65737e;"># there are another many lines likes this
</span></code></pre>
<p>这段代码中，进行了清除重复行、合并不同的DataFrame，对DataFrame的列进行清理等。这些都是数据处理中经常会遇到的任务。
这里的问题是，当这种处理逻辑比较多的时候，会出现几十行面条一样的代码，可读性很差，也难以维护（尤其在字段名称有中文的时候）。
这时候可以使用<code>pandas.DataFrame.method chain</code>来优化处理。</p>
<p>Pandas DataFrame 的 method chain，可以把多个方法放在一起。上述代码可以改写为：</p>
<pre data-lang="Python" style="background-color:#2b303b;color:#c0c5ce;" class="language-Python "><code class="language-Python" data-lang="Python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">clean_saleType</span><span>(</span><span style="color:#bf616a;">df</span><span>):
</span><span>    </span><span style="color:#65737e;"># do some cleaning
</span><span>    </span><span style="color:#b48ead;">return </span><span>df
</span><span>
</span><span>df = (df.</span><span style="color:#bf616a;">rename</span><span>(</span><span style="color:#bf616a;">columns</span><span>={&#39;</span><span style="color:#a3be8c;">old_name</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">new_name</span><span>&#39;})
</span><span>        .</span><span style="color:#bf616a;">drop_duplicates</span><span>(</span><span style="color:#bf616a;">subset</span><span>=[&#39;</span><span style="color:#a3be8c;">col1</span><span>&#39;], </span><span style="color:#bf616a;">keep</span><span>=&#39;</span><span style="color:#a3be8c;">first</span><span>&#39;)
</span><span>        .</span><span style="color:#bf616a;">merge</span><span>(df_category, </span><span style="color:#bf616a;">on</span><span>=&#39;</span><span style="color:#a3be8c;">code</span><span>&#39;, </span><span style="color:#bf616a;">how</span><span>=&#39;</span><span style="color:#a3be8c;">left</span><span>&#39;)
</span><span>        .</span><span style="color:#bf616a;">merge</span><span>(df_saleType, </span><span style="color:#bf616a;">on</span><span>=&#39;</span><span style="color:#a3be8c;">code</span><span>&#39;, </span><span style="color:#bf616a;">how</span><span>=&#39;</span><span style="color:#a3be8c;">left</span><span>&#39;)
</span><span>        .</span><span style="color:#bf616a;">merge</span><span>(product_info, </span><span style="color:#bf616a;">on</span><span>=&#39;</span><span style="color:#a3be8c;">code</span><span>&#39;, </span><span style="color:#bf616a;">how</span><span>=&#39;</span><span style="color:#a3be8c;">left</span><span>&#39;)
</span><span>        .</span><span style="color:#bf616a;">assign</span><span>(</span><span style="color:#bf616a;">cagegory</span><span>=x[&#39;</span><span style="color:#a3be8c;">category</span><span>&#39;].</span><span style="color:#bf616a;">apply</span><span>(clean_category),
</span><span>                </span><span style="color:#bf616a;">price</span><span>=x[&#39;</span><span style="color:#a3be8c;">price</span><span>&#39;].</span><span style="color:#bf616a;">apply</span><span>(clean_price))
</span><span>        .</span><span style="color:#bf616a;">pipe</span><span>(clean_saleType)
</span><span>        )
</span></code></pre>
<p>上述Method chain 由以下部分组成：</p>
<ul>
<li><code>DataFrame.drop_duplicates()</code> 等Pandas自带的，默认返回一个DataFrame的API</li>
<li><code>DataFrame.assign(**kwargs)</code> 在DataFrame中添加列，列的值根据传入的kwargs进行计算</li>
<li><code>DataFrame.pipe(func, *args, **kwargs)</code> 将用户自定义的方法引入到Method chain中</li>
</ul>
<h3 id="dataframe-assign">DataFrame.assign</h3>
<p><code>DataFrame.assign(**kwargs)</code> 作为<code>df['key'] = value</code>的替代，用来添加/替换列，且直接返回一个新的DataFrame对象，默认不会修改原有的DataFrame。
比如</p>
<pre data-lang="Python" style="background-color:#2b303b;color:#c0c5ce;" class="language-Python "><code class="language-Python" data-lang="Python"><span>df_copy = df.</span><span style="color:#bf616a;">copy</span><span>()
</span><span>df[&#39;</span><span style="color:#a3be8c;">key1</span><span>&#39;] = value1
</span><span>df[&#39;</span><span style="color:#a3be8c;">key2</span><span>&#39;] = value2
</span><span>
</span><span style="color:#65737e;"># alternative implement
</span><span>df = df.</span><span style="color:#bf616a;">assign</span><span>(</span><span style="color:#bf616a;">key1</span><span>=value1, </span><span style="color:#bf616a;">key2</span><span>=value2)
</span></code></pre>
<p>另外，pandas的很多方法可以接收类似key=func的参数，assgin也一样。可以使用类似于
<code>df = df.assign(col1_demeaned=lambda x: x.col1 - x.col1.mean())</code>这样的写法。</p>
<h3 id="dataframe-pipe">DataFrame.pipe</h3>
<p><code>df.pipe(func)</code>等价于<code>func(df)</code>，但是<code>df.pipe(func)</code>的优势在于，当连续调用多个方法的时候，可以使用类似 pipeline的写法，提高可读性。比如：</p>
<pre data-lang="Python" style="background-color:#2b303b;color:#c0c5ce;" class="language-Python "><code class="language-Python" data-lang="Python"><span>dfa = </span><span style="color:#bf616a;">func1</span><span>(df, </span><span style="color:#bf616a;">arg1</span><span>=v1)
</span><span>dfb = </span><span style="color:#bf616a;">func2</span><span>(dfb, v2, </span><span style="color:#bf616a;">arg3</span><span>=v3)
</span><span>dfc = </span><span style="color:#bf616a;">func3</span><span>(dfb, </span><span style="color:#bf616a;">arg4</span><span>=v4)
</span><span>
</span><span style="color:#65737e;"># alternative implement
</span><span>df = (df.</span><span style="color:#bf616a;">pipe</span><span>(func1, </span><span style="color:#bf616a;">arg1</span><span>=v1)
</span><span>        .</span><span style="color:#bf616a;">pipe</span><span>(func2, v2, </span><span style="color:#bf616a;">arg3</span><span>=v3)
</span><span>        .</span><span style="color:#bf616a;">pipe</span><span>(func3, </span><span style="color:#bf616a;">arg4</span><span>=v4))
</span></code></pre>
<p>同时<code>DataFrame.pipe</code>也是直接返回一个新的DataFrame，默认不修改原有的DataFrame。</p>
<p>使用Method Chain可以将数据处理的逻辑整合到一起，提升可读性。但是，凡事过犹不及，Method Chain也可能被滥用。
不合理的代码组织，混乱的处理逻辑都可能导致可读性变差。同时过长的Method Chain也会导致Debug变得困难。</p>
<p>需要注意的是，对于Method Chain过长的情况，可以通过合并处理逻辑到一个Method，通过一个DataFrame.pipe调用来优化。</p>
<h2 id="timeseries">TimeSeries</h2>
<h3 id="timeseries-slice">TimeSeries Slice</h3>
<pre data-lang="Python" style="background-color:#2b303b;color:#c0c5ce;" class="language-Python "><code class="language-Python" data-lang="Python"><span>dates = [</span><span style="color:#bf616a;">datetime</span><span>(</span><span style="color:#d08770;">2021</span><span>, </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">2</span><span>), </span><span style="color:#bf616a;">datetime</span><span>(</span><span style="color:#d08770;">2021</span><span>, </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">5</span><span>),
</span><span>         </span><span style="color:#bf616a;">datetime</span><span>(</span><span style="color:#d08770;">2021</span><span>, </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">7</span><span>), </span><span style="color:#bf616a;">datetime</span><span>(</span><span style="color:#d08770;">2021</span><span>, </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">8</span><span>),
</span><span>         </span><span style="color:#bf616a;">datetime</span><span>(</span><span style="color:#d08770;">2021</span><span>, </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">10</span><span>), </span><span style="color:#bf616a;">datetime</span><span>(</span><span style="color:#d08770;">2021</span><span>, </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">12</span><span>)]
</span><span>ts = pd.</span><span style="color:#bf616a;">Series</span><span>(np.random.</span><span style="color:#bf616a;">randn</span><span>(</span><span style="color:#d08770;">6</span><span>), </span><span style="color:#bf616a;">index</span><span>=dates)
</span></code></pre>
<p>Pandas 的 TimeSeriesIndex，可以传入字符串，比如<code>ts['2021/1/1']</code>或者<code>ts['20210102]</code>，甚至可以传入年或者年月的字符串进行筛选，比如<code>ts['2021']</code> 或者<code>ts['2021-01']</code>.Slice也完成可以直接用字符串，
比如<code>ts['20110101':'20210105']</code></p>
<p>也可以传入Datetime对象，比如<code>ts[datetime(2021, 1, 2)]</code>这样。</p>
<p>甚至还可以传入timestamp，灵活性非常高。</p>
<h3 id="timeseries-resample">TimeSeries Resample</h3>
<p>TimeSeries的聚合可以直接使用<code>pandas.DataFrame.resample</code>。根据传入freq，比如Y或者YM等进行聚合。如<code>ts.resample('M', kind='period').mean()</code></p>
<p>如果需要生成更低维度（频率）的数据，可以使用<code>DataFrame.asfreq(freq, method=None, how=None, normalize=False, fill_value=None)</code>.比如<code>ts.asfreq('4H').ffill()</code></p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://blog.xiongdong57.top/tags/pandas/">#Pandas</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;blog.xiongdong57.top&#x2F;eoq-model&#x2F;">‹ EOQ Model</a>
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://blog.xiongdong57.top/even.js" ></script>
      
    </body>

</html>
